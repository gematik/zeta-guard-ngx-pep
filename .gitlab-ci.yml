spec:
  inputs:
    sonar-quality-gate-enabled:
      description: 'Enables SonarQube [Quality Gate](https://docs.sonarsource.com/sonarqube-server/latest/quality-standards-administration/managing-quality-gates/introduction/) verification.'
      type: boolean
      default: false

---
stages:
  - build
  - test
  - deploy
  - publish

include:
  - component: "$CI_SERVER_FQDN/zeta/zeta-ci-cd-components/container-scanning@v0.3.1"
    inputs:
      analyzer-image: "$CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX/aquasec/trivy:latest"
      cs-image: "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
      git-strategy: fetch
      severity: HIGH,CRITICAL
      job-stage: test

default:
  image: $CI_REGISTRY/zeta/devops/ci-images/docker:24.0.5-zeta-0
  tags: [ zeta ]
  services:
    - name: $CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX/docker:25.0.5-dind
      alias: docker
      variables:
        HEALTHCHECK_TCP_PORT: "2376"

variables:
  DOCKER_BUILDKIT: "1"
  BUILDX_BUILDER: "ci-builder"
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: /certs
  DOCKER_CERT_PATH: $DOCKER_TLS_CERTDIR/client
  DOCKER_TLS_VERIFY: "1"
  BASE_IMAGE_BUILD: $CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX/rust:1.92-slim-bookworm
  # NOTE: must match major.minor of cargo-dependency `nginx-src`
  BASE_IMAGE: "$CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX/nginx:1.28.1-trixie-otel"
  IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA

before_script:
  - docker context create docker
  - docker buildx create --name ci-builder --use --driver docker-container --driver-opt image="$CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX/moby/buildkit:buildx-stable-1" docker
  - docker buildx use ci-builder
  - printf "%s" "$CI_DEPENDENCY_PROXY_PASSWORD" | docker login "$CI_DEPENDENCY_PROXY_SERVER" -u "$CI_DEPENDENCY_PROXY_USER" --password-stdin
  - printf "%s" "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin

build-env:
  stage: build
  variables:
  rules:
    # don't rebuild for nightly build, keep scanning the last-built image
    - if: '$CI_PIPELINE_SOURCE != "schedule"'
      when: always
  script:
    - |
      docker buildx build \
        --build-arg BUILDKIT_SYNTAX="$CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX"/docker/dockerfile:1.7 \
        --build-arg BASE_IMAGE_BUILD="$BASE_IMAGE_BUILD" \
        --build-arg BASE_IMAGE="$BASE_IMAGE" \
        --build-arg AZDO_CRATES_MIRROR_URL="$AZDO_CRATES_MIRROR_URL" \
        --cache-from type=registry,ref="$CI_REGISTRY_IMAGE:buildcache" \
        --cache-to type=registry,ref="$CI_REGISTRY_IMAGE:buildcache,mode=max,compression=zstd" \
        --secret id=azdo_pat,env=AZDO_CRATES_PAT \
        --target build-env \
        --tag "$IMAGE-build-env" \
        --push \
        "$@" \
        .

build:
  stage: build
  image: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA-build-env
  needs:
    - job: build-env
  rules:
    # don't rebuild for nightly build, keep scanning the last-built image
    - if: '$CI_PIPELINE_SOURCE != "schedule"'
      when: always
  cache:
    - key: build-$CI_COMMIT_REF_SLUG
      fallback_keys:
        - build-$CI_DEFAULT_BRANCH
        - build-default
      paths:
        - "${CI_PROJECT_DIR}/target"
        - "${CI_PROJECT_DIR}/.cargo-home"
  variables:
    IT_AUTH: https://zeta-cd.westeurope.cloudapp.azure.com/auth
  script:
    - |
      MIRROR=${AZDO_CRATES_MIRROR_URL:-} \
        TOKEN=${AZDO_CRATES_PAT:-} \
        . /usr/local/bin/cargo-env

      export CARGO_HOME="${CI_PROJECT_DIR}/.cargo-home"
      mkdir -p "$CARGO_HOME"

      IT_P12=$(mktemp)
      export IT_P12
      base64 -d "$IT_P12_B64" > "$IT_P12"

      IT_POPP_P12=$(mktemp)
      export IT_POPP_P12
      base64 -d "$IT_POPP_P12_B64" > "$IT_POPP_P12"

      misc/cargo-build

      printf "!! build image %s\n\n" "$IMAGE"

      docker buildx build \
        --build-arg BUILDKIT_SYNTAX="$CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX"/docker/dockerfile:1.7 \
        --build-arg BASE_IMAGE_BUILD="$BASE_IMAGE_BUILD" \
        --build-arg BASE_IMAGE="$BASE_IMAGE" \
        --target ci \
        --tag "$IMAGE" \
        --push \
        "$@" \
        .
  artifacts:
    when: always
    paths:
      - target/release/libngx_pep.so
      - clippy.json
      - coverage.lcov
      - .pkg-version
      - ngx_pep.cdx.json
      - prefix/test-*/logs

sonarqube:
  stage: test
  # see https://docs.sonarsource.com/sonarqube-server/analyzing-source-code/languages/rust
  before_script: [ ]
  cache:
    - key: "${CI_JOB_NAME}"
      paths:
        - "${CI_PROJECT_DIR}/.sonar/cache"
  image:
    name: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA-build-env
  needs:
    - job: build
      artifacts: true
  script:
    - >-
      sonar-scanner
      ${TRACE+-Dsonar.verbose=true}
      ${SONAR_QUALITY_GATE_ENABLED:+-Dsonar.qualitygate.wait=$SONAR_QUALITY_GATE_ENABLED}
      -Dsonar.projectVersion="$(cat /usr/src/ngx_pep/.pkg-version)"
      -Dsonar.links.homepage=${CI_PROJECT_URL}
      -Dsonar.links.ci=${CI_PROJECT_URL}/-/pipelines
      -Dsonar.links.issue=${CI_PROJECT_URL}/-/issues
  rules:
    - if: '($SONAR_HOST_URL == null || $SONAR_HOST_URL == "")'
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
    SONAR_QUALITY_GATE_ENABLED: $[[ inputs.sonar-quality-gate-enabled ]]
    # TRACE: "1"

trigger_helm:
  stage: deploy
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - when: never
  trigger:
    project: zeta/devops/zeta-guard-helm
    branch: main
    strategy: depend
  variables:
    PEPPROXY_IMAGE_TAG: "$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA" # e.g. main-cafebabe

tag_main:
  stage: publish
  rules:
    # don't trigger for nightly builds â€” they are supposed to check dependency issues in
    # *previously* built and released images, and not build/tag anything themselves.
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success
    - when: never
  needs:
    - job: build
      optional: true # resolved before rules are evaluated, which fails when schedule
    - job: trigger_helm
      optional: true
  script:
    - |
      docker pull "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
      docker tag "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA" "$CI_REGISTRY_IMAGE:$CI_DEFAULT_BRANCH"
      docker push "$CI_REGISTRY_IMAGE:$CI_DEFAULT_BRANCH"

publish_artifacts:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG
      variables:
        COMMIT_MESSAGE: "$CI_COMMIT_TAG"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "staging"
      variables:
        COMMIT_MESSAGE: "staging $CI_COMMIT_SHORT_SHA"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "release"
      variables:
        COMMIT_MESSAGE: "release $CI_COMMIT_SHORT_SHA"
      when: on_success
    - when: never
  needs:
    - job: build
      artifacts: true
  script:
    - git clone https://zeta-sdk:${REPORTING_TOKEN}@tas-devtools-gitlab.spree.de/zeta/reporting.git
    - mkdir -p ./reporting/zeta-guard/ngx_pep/
    - find . -path ./reporting -prune -o -name 'ngx_pep.cdx.json' -exec cp --parents '{}' ./reporting/zeta-guard/ngx_pep/ \;
    - find . -path ./reporting -prune -o -name 'coverage.lcov' -exec cp --parents '{}' ./reporting/zeta-guard/ngx_pep/ \;
    - cd reporting
    - git config user.email "ci@tas-devtools-gitlab.spree.de"
    - git config  user.name "ci"
    - git add .
    - git commit -m "$COMMIT_MESSAGE"
    - git push
